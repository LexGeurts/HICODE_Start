version: "3.1"

rules:

# Basic conversation rules
- rule: Respond to greeting
  steps:
  - intent: greet
  - action: utter_greet

- rule: Respond to goodbye
  steps:
  - intent: goodbye
  - action: utter_goodbye

- rule: Respond to help request
  steps:
  - intent: help
  - action: utter_help

- rule: Respond to bot challenge
  steps:
  - intent: bot_challenge
  - action: utter_iamabot

# Main flow entry points
- rule: Activate email management flow
  steps:
  - intent: manage_inbox
  - action: utter_start_management
  - action: action_activate_flow
  - slot_was_set:
      - active_flow: email_management

- rule: Activate email drafting flow
  steps:
  - intent: draft_email
  - action: utter_start_drafting
  - action: action_activate_flow
  - slot_was_set:
      - active_flow: email_drafting

- rule: Activate email search flow
  steps:
  - intent: search_emails
  - action: utter_start_search
  - action: action_activate_flow
  - slot_was_set:
      - active_flow: email_search

- rule: Activate check email flow
  steps:
  - intent: check_email
  - action: utter_checking_emails
  - action: action_check_emails

- rule: Activate read email flow from notification
  steps:
  - intent: affirm
  - active_loop: null
  - slot_was_set:
      - selected_email: true
  - action: action_read_email

- rule: Open inbox flow
  steps:
  - intent: open_inbox
  - action: utter_show_inbox
  - action: action_show_inbox

- rule: Email setup flow
  steps:
  - intent: email_setup
  - action: utter_email_setup_intro
  - action: action_show_settings

# Email management flow rules
- rule: Handle organize by folder
  condition:
  - slot_was_set:
      - active_flow: email_management
  steps:
  - intent: organize_by_folder
  - action: action_collect_folder_info

- rule: Handle filter emails
  condition:
  - slot_was_set:
      - active_flow: email_management
  steps:
  - intent: filter_emails
  - action: action_collect_filter_criteria

- rule: Handle mark as read
  condition:
  - slot_was_set:
      - active_flow: email_management
  steps:
  - intent: mark_as_read
  - action: action_mark_emails_read

- rule: Handle delete emails
  condition:
  - slot_was_set:
      - active_flow: email_management
  steps:
  - intent: delete_emails
  - action: action_confirm_delete

# Email drafting flow rules
- rule: Handle edit draft
  condition:
  - slot_was_set:
      - active_flow: email_drafting
  steps:
  - intent: edit_draft
  - action: action_collect_edits

- rule: Handle send email
  condition:
  - slot_was_set:
      - active_flow: email_drafting
  steps:
  - intent: send_email
  - action: action_confirm_send

- rule: Handle save draft
  condition:
  - slot_was_set:
      - active_flow: email_drafting
  steps:
  - intent: save_draft
  - action: action_save_draft

- rule: Handle discard draft
  condition:
  - slot_was_set:
      - active_flow: email_drafting
  steps:
  - intent: discard_draft
  - action: action_confirm_discard

# Email search flow rules
- rule: Handle search by sender
  condition:
  - slot_was_set:
      - active_flow: email_search
  steps:
  - intent: search_by_sender
  - action: action_collect_sender

- rule: Handle search by subject
  condition:
  - slot_was_set:
      - active_flow: email_search
  steps:
  - intent: search_by_subject
  - action: action_collect_subject

- rule: Handle search by date
  condition:
  - slot_was_set:
      - active_flow: email_search
  steps:
  - intent: search_by_date
  - action: action_collect_date

- rule: Handle search by content
  condition:
  - slot_was_set:
      - active_flow: email_search
  steps:
  - intent: search_by_content
  - action: action_collect_content

- rule: Handle search by attachment
  condition:
  - slot_was_set:
      - active_flow: email_search
  steps:
  - intent: search_by_attachment
  - action: action_collect_attachment

# Email action rules
- rule: Handle forward email request
  steps:
  - intent: forward_email
  - action: action_collect_sender

- rule: Handle reply to email request
  steps:
  - intent: reply_to_email
  - action: action_reply_to_email

- rule: Handle email sorting request
  steps:
  - intent: sort_results
  - action: action_search_emails

- rule: Handle export results request
  steps:
  - intent: export_results
  - action: action_search_emails

# Handle mentions of specific entities
- rule: Handle email ID mention
  steps:
  - intent: mention_email_id
  - action: action_read_email

- rule: Handle sender mention
  steps:
  - intent: mention_sender
  - action: action_collect_sender

# Handle read email request
- rule: Handle read email request
  steps:
  - intent: read_email
  - action: action_read_email
  - action: utter_post_read_options

# Handle open email request
- rule: Handle open email request
  steps:
  - intent: open_email
  - action: action_read_email

# Handle refine search request
- rule: Handle refine search
  steps:
  - intent: refine_search
  - action: action_search_emails

# Handle delete selected email
- rule: Handle delete selected email
  steps:
  - intent: delete_selected_email
  - action: action_confirm_delete

# CALM Fallback rule with rephraser
- rule: CALM fallback
  steps:
  - intent: nlu_fallback
  - action: action_calm_processor
  - slot_was_set:
      - rephrased_message: (?P<rephrased_message>.+)
  - action: action_process_rephrased
